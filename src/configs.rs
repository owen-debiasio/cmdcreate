use std::{fs::read_to_string, path::Path, sync::LazyLock};

use toml::{Value, map::Map};

use crate::utils::fs::{PATHS, overwrite_file};

const DEFAULT_CONFIG: &str = r"
# Auto-generated by cmdcreate
#
# You can find available configurations at:
# https://github.com/owen-debiasio/cmdcreate/blob/main/config_example.toml
";

pub fn init_configs() {
    if Path::new(&PATHS.configs).exists() {
        return;
    }

    overwrite_file(&PATHS.configs, DEFAULT_CONFIG);
}

static CONFIG: LazyLock<Value> = LazyLock::new(|| {
    read_to_string(&PATHS.configs)
        .ok()
        .and_then(|s| s.parse::<Value>().ok())
        .unwrap_or_else(|| Value::Table(Map::default()))
});

pub fn load(cat: &str, var: &str, default: &str) -> String {
    CONFIG
        .get(cat)
        .and_then(|c| c.get(var))
        .and_then(|v| v.as_str())
        .unwrap_or(default)
        .to_string()
}
